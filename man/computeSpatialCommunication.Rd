% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/spatial.R
\name{computeSpatialCommunication}
\alias{computeSpatialCommunication}
\title{Compute Spatial Communication}
\usage{
computeSpatialCommunication(
  object,
  method = "knn",
  k_neighbors = 6,
  symmetric = TRUE,
  distance_threshold = 150,
  sigma = 50,
  lambda = 50,
  comm_method = "geometric",
  min_production = 0.1,
  min_sensing = 0.1,
  analysis_level = "region",
  n_permutations = 1000,
  n_cores = 1,
  seed = 42,
  verbose = TRUE
)
}
\arguments{
\item{object}{A scMetaLink object with spatial information and production/sensing scores}

\item{method}{Character. Spatial weighting method:
\itemize{
  \item "knn": K-nearest neighbors only (recommended for Visium, most honest
    given the resolution limitations)
  \item "gaussian": Gaussian decay exp(-d^2/2*sigma^2)
  \item "exponential": Exponential decay exp(-d/lambda)
  \item "linear": Linear decay max(0, 1 - d/d_max)
  \item "threshold": Binary cutoff (1 if d <= threshold, 0 otherwise)
}}

\item{k_neighbors}{Integer. Number of nearest neighbors for knn method. Default: 6.
For Visium hexagonal grid, 6 corresponds to immediate neighbors.
**Note**: The weight matrix is symmetrized, so actual neighbor count per spot
may exceed k (typically k to 2k).}

\item{symmetric}{Logical. Whether to symmetrize the KNN weight matrix (default: TRUE).
If TRUE, when spot A is a neighbor of B, B is also considered a neighbor of A.
This ensures bidirectional communication potential.}

\item{distance_threshold}{Numeric. Maximum distance for communication in micrometers.
Spot pairs beyond this distance are considered non-interacting. Default: 150 um.
Note: Most metabolites have effective diffusion ranges of 10-200 um in tissue.
For Visium data (100 um spot spacing), values >200 um are rarely meaningful.}

\item{sigma}{Numeric. Sigma parameter for Gaussian decay (in um). Default: 50 um.
Represents the characteristic decay distance. Literature suggests:
\itemize{
  \item Fast-turnover metabolites (adenosine, ATP): 20-30 um
  \item Medium-range metabolites (lactate): 50-80 um
  \item Stable metabolites (amino acids): 80-120 um
}}

\item{lambda}{Numeric. Lambda parameter for exponential decay (in um). Default: 50 um.}

\item{comm_method}{Character. Communication score method: "geometric", "product", "harmonic"}

\item{min_production}{Numeric. Minimum production score threshold (0-1).
Cell types with production score below this are considered non-producers.}

\item{min_sensing}{Numeric. Minimum sensing score threshold (0-1).
Cell types with sensing score below this are considered non-sensors.}

\item{analysis_level}{Character. Level of analysis:
\itemize{
  \item "region": Aggregate by cell type (default, recommended).
    Uses the full inferProduction/inferSensing logic.
  \item "spot": Compute spot-to-spot communication.
    **WARNING**: This is a simplified implementation for exploratory analysis.
    It does NOT include: degradation adjustment, secretion weighting,
    Hill transformation, or full normalization. Use for hotspot identification only.
}}

\item{n_permutations}{Integer. Number of permutations for significance testing.
Default: 1000. For publication, recommend >= 1000 permutations.
The permutation test shuffles cell type labels while preserving spatial
structure, then **recalculates production and sensing scores** from scratch
(consistent with non-spatial version), which is the scientifically correct
null model for testing whether communication patterns are associated with
cell type identity.}

\item{n_cores}{Integer. Number of cores for parallel computing}

\item{seed}{Integer. Random seed for reproducibility}

\item{verbose}{Logical. Print progress messages}
}
\value{
Updated scMetaLink object with spatial_communication slot
}
\description{
Calculate spatially-weighted metabolite-mediated communication.
  This function incorporates spatial distance between spots to weight
  communication strength.
}
\details{
**Important Notes on Spatial Resolution:**

For Visium data (55 um spots, ~100 um spacing), each spot contains 1-10 cells.
This means:
\itemize{
  \item Cell type annotations should ideally come from deconvolution methods
    (e.g., RCTD, cell2location, SPOTlight)
  \item The "knn" method (k=6) is recommended as it only considers immediate
    neighbors, which is most honest given the resolution limitations
  \item Distance-weighted methods (gaussian, exponential) may provide
    "false precision" when spot spacing is similar to metabolite diffusion distance
}

**Permutation Test Design:**

The permutation test shuffles cell type labels (not spatial positions) and
**recalculates production/sensing scores from expression data**. This is
consistent with the non-spatial version and tests whether the observed
communication pattern is associated with cell type identity beyond what
would be expected by chance.

**Spatial communication is modeled as:**
\deqn{C_{spatial}(i -> j, m) = MPP(m, i) * MSC(m, j) * w(d_{ij})}

where w(d) is the spatial weight function:
\itemize{
  \item Gaussian: w(d) = exp(-d^2 / 2*sigma^2)
  \item Exponential: w(d) = exp(-d / lambda)
  \item Linear: w(d) = max(0, 1 - d/d_max)
  \item Threshold: w(d) = I(d <= d_threshold)
}
}
\examples{
\donttest{
data(st_expr)
data(st_meta)
data(st_scalefactors)

# Create object and run analysis
obj <- createScMetaLinkFromSpatial(st_expr, st_meta[,c("x","y")],
                                   st_meta, "cell_type", st_scalefactors)
obj <- inferProduction(obj)
obj <- inferSensing(obj)

# Compute spatial communication (knn method recommended for Visium)
obj <- computeSpatialCommunication(obj, method = "knn", k_neighbors = 6)

# Alternative: Gaussian decay with conservative parameters
obj <- computeSpatialCommunication(obj, method = "gaussian",
                                   sigma = 50,  # 50 um decay
                                   distance_threshold = 150)  # max 150 um
}
}
